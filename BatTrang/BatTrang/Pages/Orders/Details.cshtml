@page "/Orders/{code}"
@model BatTrang.Pages.Orders.DetailsModel
@{
    ViewData["Title"] = "Chi tiết đơn hàng";
}

<style>
    /* Layout & invoice look */
    .invoice {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 12px;
    }

    .invoice-header {
        border-bottom: 1px solid #e9ecef;
    }

    .badge-soft {
        background: rgba(25,135,84,.12);
        color: #198754;
        border: 1px solid rgba(25,135,84,.2);
    }

    .table-invoice th, .table-invoice td {
        vertical-align: middle;
    }

    .totals-box .row > div {
        padding: .25rem 0;
    }

        .totals-box .row > div strong {
            font-weight: 600;
        }

    /* Print styles */
    @@media print {
        .no-print {
            display: none !important;
        }

        body {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        @@page {
            size: A4 portrait;
            margin: 14mm;
        }

        .invoice {
            border: none;
        }
    }
</style>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3 no-print">
    <h2 class="mb-0">Chi tiết đơn hàng</h2>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="/Products"><i class="fa-solid fa-chevron-left me-1"></i>Tiếp tục mua sắm</a>
      <button class="btn btn-primary" onclick="window.print()"><i class="fa-solid fa-print me-1"></i>In hóa đơn</button>
    </div>
  </div>

  <div class="invoice shadow-sm p-4">
    <!-- Header -->
    <div class="invoice-header pb-3 mb-3">
      <div class="row g-3">
        <div class="col-md">
          <h4 class="mb-1">Hóa đơn bán hàng</h4>
          <div class="text-muted small">@Model.ShopName</div>
          <div class="text-muted small">@Model.ShopAddress</div>
          <div class="text-muted small">Hotline: @Model.ShopPhone • Email: @Model.ShopEmail</div>
        </div>
        <div class="col-md text-md-end">
          <div class="mb-1">
            <span class="text-muted">Mã đơn:</span>
            <strong class="ms-1">@Model.Order.OrderCode</strong>
          </div>
          <div class="mb-1">
            <span class="text-muted">Ngày tạo:</span>
            <strong class="ms-1">@Model.Order.CreatedAt.ToLocalTime().ToString("HH:mm dd/MM/yyyy")</strong>
          </div>
          <div>
            <span class="text-muted">Trạng thái:</span>
            @if (Model.Order.Status?.ToUpperInvariant() == "PAID")
            { <span class="badge bg-success ms-1">ĐÃ THANH TOÁN</span> }
            else
            { <span class="badge bg-secondary ms-1">@(Model.Order.Status ?? "CREATED")</span> }
          </div>
        </div>
      </div>
    </div>

    <!-- Customer & Payment -->
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <div class="fw-semibold mb-2"><i class="fa-regular fa-user me-1"></i>Thông tin người nhận</div>
          <div><strong>@Model.Order.FullName</strong></div>
          <div class="text-muted small">@Model.Order.Phone @if(!string.IsNullOrEmpty(Model.Order.Email)){<text>• @Model.Order.Email</text>}</div>
          <div class="text-muted small">
            @Model.Order.Address
            @if(!string.IsNullOrWhiteSpace(Model.Order.Ward)){<text>, @Model.Order.Ward</text>}
            @if(!string.IsNullOrWhiteSpace(Model.Order.District)){<text>, @Model.Order.District</text>}
            @if(!string.IsNullOrWhiteSpace(Model.Order.Province)){<text>, @Model.Order.Province</text>}
          </div>
          @if(!string.IsNullOrWhiteSpace(Model.Order.Note)){
            <div class="mt-2"><span class="text-muted small">Ghi chú:</span> @Model.Order.Note</div>
          }
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <div class="fw-semibold mb-2"><i class="fa-regular fa-credit-card me-1"></i>Thanh toán</div>
          <div>
            @if (Model.Order.PaymentMethod?.ToUpperInvariant() == "COD")
            { <span class="badge rounded-pill bg-secondary">COD (Thanh toán khi nhận hàng)</span> }
            else
            { <span class="badge rounded-pill badge-soft">Thanh toán trực tiếp</span> }
          </div>
          @if (Model.Order.PaymentMethod?.ToUpperInvariant() == "DIRECT")
          {
            <div class="text-muted small mt-2">
              Trả tại cửa hàng hoặc chuyển khoản:
              <div><strong>Ngân hàng:</strong> ABC Bank</div>
              <div><strong>STK:</strong> 123456789 • <strong>Chủ TK:</strong> Công ty Gốm Bát Tràng</div>
              <div><strong>Nội dung:</strong> @Model.Order.OrderCode + SĐT</div>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Items -->
    <div class="table-responsive mb-3">
      <table class="table table-sm table-bordered table-invoice">
        <thead class="table-light">
          <tr>
            <th style="width:56px" class="text-center">#</th>
            <th>Sản phẩm</th>
            <th class="text-end" style="width:140px">Đơn giá</th>
            <th class="text-center" style="width:100px">SL</th>
            <th class="text-end" style="width:160px">Thành tiền</th>
          </tr>
        </thead>
        <tbody>
          @for (int i = 0; i < Model.Items.Count; i++)
          {
              var it = Model.Items[i];
              <tr>
                <td class="text-center">@(@i + 1)</td>
                <td>@it.ProductName</td>
                <td class="text-end">@Model.FormatCurrency(it.UnitPrice)</td>
                <td class="text-center">@it.Quantity</td>
                <td class="text-end">@Model.FormatCurrency(it.UnitPrice * it.Quantity)</td>
              </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Totals -->
    <div class="row g-3">
      <div class="col-md-6">
        <div class="small text-muted">
          Cảm ơn bạn đã mua sắm! Nếu có thắc mắc về đơn hàng, vui lòng liên hệ hotline
          <a href="tel:@Model.ShopPhone">@Model.ShopPhone</a>.
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded p-3 totals-box">
          <div class="row">
            <div class="col">Tạm tính</div>
            <div class="col text-end"><strong>@Model.FormatCurrency(Model.Order.Subtotal)</strong></div>
          </div>
          <div class="row">
            <div class="col">Phí vận chuyển</div>
            <div class="col text-end"><strong>@Model.FormatCurrency(Model.Order.ShippingFee)</strong></div>
          </div>
          <div class="row">
            <div class="col">Giảm giá</div>
            <div class="col text-end"><strong>-@Model.FormatCurrency(Model.Order.Discount)</strong></div>
          </div>
          <hr/>
          <div class="row">
            <div class="col"><strong>TỔNG CỘNG</strong></div>
            <div class="col text-end"><strong class="text-success">@Model.FormatCurrency(Model.Order.Total)</strong></div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-4 text-center no-print">
      <button class="btn btn-outline-secondary me-2" onclick="window.print()"><i class="fa-solid fa-print me-1"></i>In hóa đơn</button>
      <a class="btn btn-success" href="/Products"><i class="fa-solid fa-bag-shopping me-1"></i>Tiếp tục mua sắm</a>
    </div>
  </div>
</div>
